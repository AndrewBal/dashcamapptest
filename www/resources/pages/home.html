<template>
    <div class="page home-page" data-name="home">
        <!-- Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="/panel-left/" class="link icon-only">
                        <i class="f7-icons">bars</i>
                    </a>
                </div>
                <div class="title">Home</div>
                <div class="right">
                    <a href="#" class="link icon-only" @click="openCameraSelector">
                        <i class="f7-icons">plus_circle</i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Toolbar Bottom -->
        <div class="toolbar toolbar-bottom no-hairline">
            <div class="toolbar-inner toolbar-buttons">
                <a href="#" class="btn-cs {{#if IsConnected}}btn-connected{{/if}}" @click="handleConnect">
                    {{#if IsConnected}}CONNECTED{{else}}CONNECT{{/if}}
                </a>
                <a href="#" class="btn-cs" @click="handleLive">
                    LIVE
                </a>
            </div>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            <!-- Camera Selector -->
            <div class="list no-hairlines no-margin-top">
                <ul>
                    <li>
                        <a href="#" class="item-link item-content" @click="openCameraSelector">
                            <div class="item-media"><i class="f7-icons color-theme">camera_fill</i></div>
                            <div class="item-inner">
                                <div class="item-title">Select Camera</div>
                                <div class="item-after">{{SelectedCameraName}}</div>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Connection Status -->
                <div class="connection-status">
                    <span class="status-dot {{#if IsConnected}}connected{{else}}disconnected{{/if}}"></span>
                    <span>{{#if IsConnected}}Connected{{else}}Not Connected{{/if}}</span>
                </div>

                <!-- Camera Icon -->
                <div class="camera-icon-wrapper">
                    <svg class="main-bg" viewBox="0 0 200 150" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="30" y="30" width="140" height="90" rx="10" stroke="{{#if IsConnected}}#4cd964{{else}}#48c6ef{{/if}}" stroke-width="4" fill="none" opacity="0.3"/>
                        <circle cx="100" cy="75" r="30" stroke="{{#if IsConnected}}#4cd964{{else}}#6f86d6{{/if}}" stroke-width="4" fill="none" opacity="0.5"/>
                        <circle cx="100" cy="75" r="15" stroke="{{#if IsConnected}}#4cd964{{else}}#48c6ef{{/if}}" stroke-width="3" fill="none" opacity="0.7"/>
                        <rect x="20" y="60" width="15" height="30" rx="3" stroke="{{#if IsConnected}}#4cd964{{else}}#6f86d6{{/if}}" stroke-width="3" fill="none" opacity="0.3"/>
                        <rect x="165" y="60" width="15" height="30" rx="3" stroke="{{#if IsConnected}}#4cd964{{else}}#6f86d6{{/if}}" stroke-width="3" fill="none" opacity="0.3"/>
                    </svg>
                </div>

                <!-- Instructions -->
                {{#if IsConnected}}
                <p class="text-content">Camera connected. You can now view live stream or access the gallery.</p>
                {{else}}
                <p class="text-content">You have not had any connections to the dashcam.</p>
                <p class="text-content">Click CONNECT to open WiFi settings and connect to your dashcam network.</p>
                {{/if}}
            </div>

            <!-- Quick Actions (visible when connected) -->
            {{#if IsConnected}}
            <div class="action-buttons">
                <a href="#" class="action-btn" @click="takePhoto">
                    <i class="f7-icons">camera</i>
                </a>
                <a href="#" class="action-btn large" @click="handleLive">
                    <i class="f7-icons">play_fill</i>
                </a>
                <a href="/gallery/" class="action-btn">
                    <i class="f7-icons">photo_on_rectangle</i>
                </a>
            </div>
            {{/if}}
        </div>
    </div>
</template>

<style>
    .btn-connected {
        background: linear-gradient(to right, #4cd964, #34c759) !important;
    }
</style>

<script>
    return {
        data: function() {
            var camera = AppStore.state.selectedCamera;
            return {
                IsConnected: AppStore.state.isConnected,
                SelectedCameraName: camera ? camera.name : 'Default (192.168.0.1)'
            };
        },
        methods: {
            handleConnect: function() {
                var self = this;
                // This will check connection and open WiFi settings if not connected
                self.$app.methods.connectToCamera().then(function(connected) {
                    if (connected) {
                        self.$setState({
                            IsConnected: true
                        });
                    }
                });
            },
            handleLive: function() {
                this.$app.methods.openLiveStream();
            },
            openCameraSelector: function() {
                this.$app.methods.openCameraSelector();
            },
            takePhoto: function() {
                this.$app.methods.takePhoto();
            },
            updateState: function() {
                var camera = AppStore.state.selectedCamera;
                var newConnected = AppStore.state.isConnected;
                var newCameraName = camera ? camera.name : 'Default (192.168.0.1)';
                
                // Only update if changed
                if (newConnected !== this.IsConnected || newCameraName !== this.SelectedCameraName) {
                    this.$setState({
                        IsConnected: newConnected,
                        SelectedCameraName: newCameraName
                    });
                }
            }
        },
        on: {
            pageInit: function(e, page) {
                var self = this;
                // Update state every 2 seconds to catch connection changes
                self.interval = setInterval(function() {
                    self.updateState();
                }, 2000);
            },
            pageBeforeRemove: function() {
                if (this.interval) {
                    clearInterval(this.interval);
                }
            }
        }
    };
</script>