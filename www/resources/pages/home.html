<template>
    <div class="page home-page" data-name="home">
        <!-- Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="/panel-left/" class="link icon-only">
                        <i class="f7-icons icon-menu size-21"></i>
                    </a>
                </div>
                <div class="title">Home</div>
                <div class="right">
                    <a href="#" class="link icon-only" @click="openCameraSelector">
                        <i class="f7-icons icon-add size-21"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Toolbar Bottom -->
        <div class="toolbar toolbar-bottom no-hairline">
            <div class="toolbar-inner toolbar-buttons">

                <a href="#" class="btn-cs bgcolor-black {{#if IsConnected}}btn-connected{{/if}}" @click="handleConnect">
                    {{#if IsConnected}}CONNECTED{{else}}CONNECT{{/if}}
                </a>

                <a href="#" class="btn-cs" @click="handleLive">
                    LIVE
                </a>
            </div>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            <!-- Camera Selector -->
            <div class="list no-hairlines no-margin-top">
                <ul>
                    <li>
                        <a href="#" class="item-link item-content" @click="openCameraSelector">
                            <div class="item-media"><i class="f7-icons icon-live color-lightgray size-21"></i></div>
                            <div class="item-inner" style="border-bottom: 1px solid #ccc;">
                                <div class="item-title">Select Camera</div>
                                <div class="item-after">{{SelectedCameraName}}</div>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Connection Status -->
                <div class="connection-status">
                    <span class="status-dot {{#if IsConnected}}connected{{else}}disconnected{{/if}}"></span>
                    <span>{{#if IsConnected}}Connected{{else}}Not Connected{{/if}}</span>
                </div>

                <!-- Camera Icon -->
                <div class="camera-icon-wrapper">
                    <i class="f7-icons icon-dashcam  size-165 {{#if IsConnected}}color-green{{else}}color-lightgray{{/if}}"></i>
                </div>

                <!-- Instructions -->
                {{#if IsConnected}}
                <p class="text-content">Camera connected. You can now view live stream or access the gallery.</p>
                {{else}}
                <p class="text-content">You have not had any connections to the dashcam.</p>
                <p class="text-content">Click CONNECT to open WiFi settings and connect to your dashcam network.</p>
                {{/if}}
            </div>

            <!-- Quick Actions (visible when connected) -->
            {{#if IsConnected}}
            <div class="action-buttons">
                <a href="#" class="action-btn" @click="takePhoto">
                    <i class="f7-icons icon-photo"></i>
                </a>
                <a href="#" class="action-btn large" @click="handleLive">
                    <i class="f7-icons icon-play"></i>
                </a>
                <a href="/gallery/" class="action-btn">
                    <i class="f7-icons icon-gallery"></i>
                </a>
            </div>
            {{/if}}
        </div>
    </div>
</template>

<style>
    .btn-connected {
        background: linear-gradient(to right, #5fb257, #52ab4a) !important;
    }
</style>

<script>
    return {
        data: function () {
            var camera = AppStore.state.selectedCamera;
            return {
                IsConnected:  AppStore.state.isConnected,
                SelectedCameraName: camera ? camera.name : 'Default (192.168.0.1)'
            };
        },
        methods: {
            handleConnect: function () {
                var self = this;
                // This will check connection and open WiFi settings if not connected
                self.$app.methods.connectToCamera().then(function (connected) {
                    if (connected) {
                        self.$setState({
                            IsConnected: true
                        });
                    }
                });
            },
            handleLive: function () {
                this.$app.methods.openLiveStream();
            },
            openCameraSelector: function () {
                this.$app.methods.openCameraSelector();
            },
            takePhoto: function () {
                this.$app.methods.takePhoto();
            },
            updateState: function () {
                var camera = AppStore.state.selectedCamera;
                var newConnected = AppStore.state.isConnected;
                var newCameraName = camera ? camera.name : 'Default (192.168.0.1)';

                // Only update if changed
                if (newConnected !== this.IsConnected || newCameraName !== this.SelectedCameraName) {
                    this.$setState({
                        IsConnected: newConnected,
                        SelectedCameraName: newCameraName
                    });
                }
            }
        },
        on: {
            pageInit: function (e, page) {
                var self = this;
                 //  Update state every 2 seconds to catch connection changes
             self.interval = setInterval(function() {
                   self.updateState();
               }, 2000);  
            },
            pageBeforeRemove: function () {
                if (this.interval) {
                    clearInterval(this.interval);
                }
            }
        }
    };
</script>