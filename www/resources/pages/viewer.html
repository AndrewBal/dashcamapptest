<template>
    <div class="page viewer-page" data-name="viewer">
        <!-- Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="f7-icons">chevron_left</i>
                    </a>
                </div>
                <div class="title">{{filename}}</div>
                <div class="right">
                    <a href="#" class="link icon-only" @click="shareFile">
                        <i class="f7-icons">square_arrow_up</i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Bottom Toolbar -->
        <div class="toolbar toolbar-bottom viewer-toolbar">
            <div class="toolbar-inner">
                <a href="#" class="link" @click="downloadFile">
                    <i class="f7-icons icon-download"></i>
                    <span class="font-bold">DOWNLOAD</span>
                </a>
                <a href="#" class="link color-red" @click="deleteFile">
                   <i class="f7-icons icon-delete"></i>
                    <span class="font-bold">DELETE</span>
                </a>
            </div>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            <div class="viewer-container">
                {{#if isPhoto}}
                <!-- Photo Viewer -->
                <div class="photo-viewer">
                    <img src="{{fileUrl}}" alt="{{filename}}" @click="toggleControls">
                </div>
                {{else}}
                <!-- Video Viewer - показываем превью и кнопку Play -->
                <div class="video-viewer">
                    <div class="video-preview">
                        <!-- Thumbnail or placeholder -->
                        <div class="video-thumbnail">
                            <img src="{{thumbnailUrl}}" onerror="this.style.display='none'" alt="">
                            <div class="video-placeholder">
                                <i class="f7-icons">film</i>
                            </div>
                        </div>
                        
                        <!-- Play button overlay -->
                        <a href="#" class="play-button" @click="playVideo">
                            <i class="f7-icons">play_fill</i>
                        </a>
                    </div>
                    
                    <p class="video-hint">Tap to play in video player</p>
                </div>
                {{/if}}
            </div>
            
            <!-- File Info -->
            <div class="file-info">
                <div class="file-info-row">
                    <span class="label">Filename:</span>
                    <span class="value">{{filename}}</span>
                </div>
                {{#if formattedDate}}
                <div class="file-info-row">
                    <span class="label">Date:</span>
                    <span class="value">{{formattedDate}}</span>
                </div>
                {{/if}}
                <div class="file-info-row">
                    <span class="label">Type:</span>
                    <span class="value">{{#if isPhoto}}Photo{{else}}Video{{/if}}</span>
                </div>
                <div class="file-info-row">
                    <span class="label">Camera:</span>
                    <span class="value">{{cameraLabel}}</span>
                </div>
            </div>
        </div>
    </div>
</template>

<style>
    .viewer-page {
        --f7-page-bg-color: #000;
        background: #000;
    }
    
    .viewer-page .navbar {
        --f7-navbar-bg-color: rgba(0,0,0,0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    
    .viewer-page .page-content {
        background: #000;
        padding-bottom: 80px;
    }
    
    /* Viewer Container */
    .viewer-page .viewer-container {
        width: 100%;
        min-height: 50vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
    }
    
    /* Photo Viewer */
    .viewer-page .photo-viewer {
        width: 100%;
        text-align: center;
    }
    
    .viewer-page .photo-viewer img {
        max-width: 100%;
        max-height: 70vh;
        object-fit: contain;
    }
    
    /* Video Viewer */
    .viewer-page .video-viewer {
        width: 100%;
        text-align: center;
        padding: 20px;
    }
    
    .viewer-page .video-preview {
        position: relative;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        aspect-ratio: 16/9;
        background: #1a1a1a;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .viewer-page .video-thumbnail {
        width: 100%;
        height: 100%;
        position: relative;
    }
    
    .viewer-page .video-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .viewer-page .video-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .viewer-page .video-placeholder i {
        font-size: 64px;
        color: rgba(255,255,255,0.3);
    }
    
    .viewer-page .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background: rgba(255,255,255,0.9);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        transition: transform 0.2s, background 0.2s;
    }
    
    .viewer-page .play-button:active {
        transform: translate(-50%, -50%) scale(0.95);
        background: rgba(255,255,255,1);
    }
    
    .viewer-page .play-button i {
        font-size: 36px;
        color: #333;
        margin-left: 4px;  
    }
    
    .viewer-page .video-hint {
        color: rgba(255,255,255,0.5);
        font-size: 13px;
        margin-top: 15px;
    }
    
     .viewer-page .viewer-toolbar {
        background: rgba(0,0,0,0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .viewer-page .viewer-toolbar .toolbar-inner {
        justify-content: space-around;
    }
    
    .viewer-page .viewer-toolbar .link {
        display: flex;
         align-items: center;
        gap: 4px;
        padding: 10px 30px;
        color: #fff;
        font-size: 12px;
    }
    
    .viewer-page .viewer-toolbar .link i {
        font-size: 24px;
    }
    
    .viewer-page .viewer-toolbar .link.color-red {
        color: #ff3b30;
    }
    
    /* File Info */
    .viewer-page .file-info {
        padding: 20px;
        background: rgba(255,255,255,0.05);
        margin: 20px 15px;
        border-radius: 12px;
    }
    
    .viewer-page .file-info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        color: white;
        font-size: 14px;
    }
    
    .viewer-page .file-info-row:last-child {
        border-bottom: none;
    }
    
    .viewer-page .file-info-row .label {
        color: rgba(255,255,255,0.5);
    }
    
    .viewer-page .file-info-row .value {
        text-align: right;
        max-width: 60%;
        word-break: break-all;
    }
</style>

<script>
    return {
        data: function() {
            return {
                type: '',
                filename: '',
                fileUrl: '',
                thumbnailUrl: '',
                isPhoto: false,
                formattedDate: '',
                cameraLabel: 'Front',
                controlsVisible: true
            };
        },
        methods: {
            initViewer: function() {
                var self = this;
                var route = self.$f7route;
                
                self.type = route.params.type;
                self.filename = decodeURIComponent(route.params.filename);
                
                // Determine if photo or video
                self.isPhoto = self.type === 'snapshot' || 
                               self.filename.toLowerCase().indexOf('.jpg') !== -1 ||
                               self.filename.toLowerCase().indexOf('.jpeg') !== -1 ||
                               self.filename.toLowerCase().indexOf('.png') !== -1;
                
                // Get camera from AppStore
                var camera = AppStore.state.currentCamera || 'front';
                self.cameraLabel = camera === 'front' ? 'Front' : 'Rear';
                
                // Determine directory
                var dir = self.getDirectory(self.type, camera);
                
                // Build file URL
                self.fileUrl = DASHCAM_API.getFileUrl ? 
                    DASHCAM_API.getFileUrl(dir, self.filename) :
                    DASHCAM_API.baseUrl + '/sd//' + dir + '/' + self.filename;
                
                // Build thumbnail URL for videos (.TS -> .THM)
                if (!self.isPhoto) {
                    self.thumbnailUrl = self.fileUrl.replace(/\.(TS|ts)$/i, '.THM');
                }
                
                // Parse date from filename
                self.formattedDate = self.parseDateFromFilename(self.filename);
                
                self.$setState({
                    type: self.type,
                    filename: self.filename,
                    fileUrl: self.fileUrl,
                    thumbnailUrl: self.thumbnailUrl,
                    isPhoto: self.isPhoto,
                    formattedDate: self.formattedDate,
                    cameraLabel: self.cameraLabel
                });
                
                console.log('[Viewer] Initialized:', {
                    type: self.type,
                    filename: self.filename,
                    fileUrl: self.fileUrl,
                    isPhoto: self.isPhoto
                });
            },
            
            getDirectory: function(type, camera) {
                var dirs = DASHCAM_API.directories;
                
                switch(type) {
                    case 'loop':
                        return camera === 'front' ? dirs.loopFront : dirs.loopRear;
                    case 'locked':
                        return camera === 'front' ? dirs.lockedFront : dirs.lockedRear;
                    case 'snapshot':
                        return camera === 'front' ? dirs.snapshotFront : dirs.snapshotRear;
                    default:
                        return dirs.loopFront;
                }
            },
            
            parseDateFromFilename: function(filename) {
                // Format: 2026_01_24_115023_00.TS
                var match = filename.match(/(\d{4})_(\d{2})_(\d{2})_(\d{2})(\d{2})(\d{2})/);
                if (match) {
                    var date = new Date(
                        parseInt(match[1], 10),
                        parseInt(match[2], 10) - 1,
                        parseInt(match[3], 10),
                        parseInt(match[4], 10),
                        parseInt(match[5], 10),
                        parseInt(match[6], 10)
                    );
                    
                    // Format date
                    var d = date.getDate().toString().padStart(2, '0');
                    var m = (date.getMonth() + 1).toString().padStart(2, '0');
                    var y = date.getFullYear();
                    var h = date.getHours().toString().padStart(2, '0');
                    var min = date.getMinutes().toString().padStart(2, '0');
                    var sec = date.getSeconds().toString().padStart(2, '0');
                    
                    return d + '.' + m + '.' + y + ' ' + h + ':' + min + ':' + sec;
                }
                return '';
            },
            
            toggleControls: function() {
                var self = this;
                self.controlsVisible = !self.controlsVisible;
                
                if (self.controlsVisible) {
                    self.$el.find('.navbar, .viewer-toolbar').show();
                } else {
                    self.$el.find('.navbar, .viewer-toolbar').hide();
                }
            },
            
            // Play video using ExoPlayer plugin or system player
            playVideo: function() {
                var self = this;
                
                console.log('[Viewer] Playing video:', self.fileUrl);
                
                // Try ExoPlayer plugin first (same as RTSP player)
                if (window.RtspPlayer) {
                    console.log('[Viewer] Using RtspPlayer/ExoPlayer');
                    window.RtspPlayer.play(self.fileUrl,
                        function(status) {
                            console.log('[Viewer] Player status:', status);
                        },
                        function(error) {
                            console.error('[Viewer] ExoPlayer error:', error);
                            // Fallback to system player
                            self.openSystemPlayer();
                        }
                    );
                } else {
                    // Fallback to system player
                    self.openSystemPlayer();
                }
            },
            
            // Open in system video player
            openSystemPlayer: function() {
                var self = this;
                
                console.log('[Viewer] Opening in system player:', self.fileUrl);
                
                if (window.cordova && cordova.InAppBrowser) {
                    cordova.InAppBrowser.open(self.fileUrl, '_system');
                } else {
                    window.open(self.fileUrl, '_blank');
                }
            },
            
            downloadFile: function() {
                var self = this;
                
                self.$app.dialog.confirm(
                    'Download this file to your device?',
                    'Download',
                    function() {
                        if (window.cordova) {
                            self.cordovaDownload();
                        } else {
                            self.webDownload();
                        }
                    }
                );
            },
            
            webDownload: function() {
                var self = this;
                var a = document.createElement('a');
                a.href = self.fileUrl;
                a.download = self.filename;
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                self.$app.toast.show({
                    text: 'Download started',
                    position: 'center',
                    closeTimeout: 2000
                });
            },
            
            // FIXED: Download without FileTransfer plugin
            cordovaDownload: function() {
                var self = this;

                // Check if cordova-plugin-file is available
                if (typeof cordova === 'undefined' || !cordova.file) {
                    self.$app.toast.show({
                        text: 'File plugin not available, opening in browser...',
                        position: 'center',
                        closeTimeout: 2000
                    });
                    // Fallback - open in system browser/app
                    if (cordova && cordova.InAppBrowser) {
                        cordova.InAppBrowser.open(self.fileUrl, '_system');
                    } else {
                        window.open(self.fileUrl, '_blank');
                    }
                    return;
                }

                self.$app.toast.show({
                    text: 'Downloading ' + self.filename + '...',
                    position: 'center',
                    closeTimeout: 1500
                });

                // Use XMLHttpRequest + Blob + cordova-plugin-file
                var xhr = new XMLHttpRequest();
                xhr.open('GET', self.fileUrl, true);
                xhr.responseType = 'blob';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        var blob = xhr.response;
                        self.saveBlobToFile(blob, self.filename);
                    } else {
                        self.$app.toast.show({
                            text: 'Download failed: ' + xhr.status,
                            position: 'center',
                            closeTimeout: 2000
                        });
                    }
                };

                xhr.onerror = function () {
                    console.error('Download XHR error');
                    self.$app.toast.show({
                        text: 'Download failed',
                        position: 'center',
                        closeTimeout: 2000
                    });
                };

                xhr.send();
            },

            saveBlobToFile: function (blob, filename) {
                var self = this;

                // Determine storage location
                var storageLocation = '';

                if (cordova.file.externalRootDirectory) {
                    // Android - save to Download folder
                    storageLocation = cordova.file.externalRootDirectory + 'Download/';
                } else if (cordova.file.documentsDirectory) {
                    // iOS - save to Documents
                    storageLocation = cordova.file.documentsDirectory;
                } else {
                    // Fallback to app data directory
                    storageLocation = cordova.file.dataDirectory;
                }

                window.resolveLocalFileSystemURL(storageLocation, function (dirEntry) {
                    dirEntry.getFile(filename, { create: true, exclusive: false }, function (fileEntry) {
                        fileEntry.createWriter(function (fileWriter) {
                            fileWriter.onwriteend = function () {
                                console.log('File saved: ' + fileEntry.nativeURL);
                                self.$app.toast.show({
                                    text: 'Downloaded to Downloads folder',
                                    position: 'center',
                                    closeTimeout: 2000
                                });
                            };

                            fileWriter.onerror = function (e) {
                                console.error('Write error:', e);
                                self.$app.toast.show({
                                    text: 'Save failed',
                                    position: 'center',
                                    closeTimeout: 2000
                                });
                            };

                            fileWriter.write(blob);
                        });
                    }, function (error) {
                        console.error('getFile error:', error);
                        self.$app.toast.show({
                            text: 'Cannot create file',
                            position: 'center',
                            closeTimeout: 2000
                        });
                    });
                }, function (error) {
                    console.error('resolveLocalFileSystemURL error:', error);
                    self.$app.toast.show({
                        text: 'Cannot access storage',
                        position: 'center',
                        closeTimeout: 2000
                    });
                });
            },
            
            deleteFile: function() {
                var self = this;
                
                self.$app.dialog.confirm(
                    'Delete this file? This cannot be undone.',
                    'Delete',
                    function() {
                        // TODO: Implement delete API
                        self.$app.toast.show({
                            text: 'Delete API not implemented yet',
                            position: 'center',
                            closeTimeout: 2000
                        });
                    }
                );
            },
            
            shareFile: function() {
                var self = this;
                
                if (window.plugins && window.plugins.socialsharing) {
                    window.plugins.socialsharing.share(
                        null,
                        self.filename,
                        self.fileUrl,
                        null
                    );
                } else if (navigator.share) {
                    navigator.share({
                        title: self.filename,
                        url: self.fileUrl
                    }).catch(function(err) {
                        console.log('Share error:', err);
                    });
                } else {
                    // Fallback - copy URL to clipboard
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(self.fileUrl).then(function() {
                            self.$app.toast.show({
                                text: 'URL copied to clipboard',
                                position: 'center',
                                closeTimeout: 2000
                            });
                        });
                    } else {
                        self.$app.toast.show({
                            text: 'Share not available',
                            position: 'center',
                            closeTimeout: 2000
                        });
                    }
                }
            }
        },
        on: {
            pageInit: function(e, page) {
                var self = this;
                self.initViewer();
            },
            pageBeforeRemove: function() {
                // Nothing to cleanup
            }
        }
    };
</script>