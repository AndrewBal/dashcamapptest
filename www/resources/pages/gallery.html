<template>
    <div class="page gallery-page" data-name="gallery">
        <!-- Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="/panel-left/" class="link icon-only">
                        <i class="f7-icons icon-menu size-21"></i>
                    </a>
                </div>
                <div class="title">Gallery</div>
                <div class="right">
                    <a href="#" class="link icon-only" @click="refreshGallery">
                        <i class="f7-icons icon-update size-21"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="toolbar tabbar toolbar-top">
            <div class="toolbar-inner">
                <a href="#tab-loop" class="tab-link tab-link-active">Loop</a>
                <a href="#tab-locked" class="tab-link">Locked</a>
                <a href="#tab-snapshot" class="tab-link">Snapshot</a>
            </div>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            <!-- Camera Filter -->
            <div class="camera-filter">
                <a href="#" class="button  button-fill  color-theme" @click="setCameraFilter('front')">Front</a>
                <a href="#" class="button  button-fill  color-theme" @click="setCameraFilter('rear')">Rear</a>
            </div>

            <div class="tabs">
                <!-- Loop Tab -->
                <div id="tab-loop" class="tab tab-active">
                    {{#if Loading}}
                    <div class="gallery-empty">
                        <div class="preloader"></div>
                        <p>Loading...</p>
                    </div>
                    {{else}}
                        {{#if hasLoopFiles}}
                        <div class="gallery-grid">
                            {{#each LoopFiles}}
                            <div class="gallery-item" data-url="{{url}}">
                                <div class="item-thumb-placeholder">
                                    <i class="f7-icons">film</i>
                                </div>
                                <img class="item-thumb" src="{{thumbnailUrl}}" onload="this.style.opacity=1" onerror="this.style.display='none'">
                                <div class="item-overlay">{{formattedDate}}</div>
                                <div class="item-badge"><i class="f7-icons">play_fill</i></div>
                            </div>
                            {{/each}}
                        </div>
                        {{else}}
                        <div class="gallery-empty">
                            <i class="f7-icons">film</i>
                            <p>No loop recordings found</p>
                        </div>
                        {{/if}}
                    {{/if}}
                </div>

                <!-- Locked Tab -->
                <div id="tab-locked" class="tab">
                    {{#if Loading}}
                    <div class="gallery-empty">
                        <div class="preloader"></div>
                        <p>Loading...</p>
                    </div>
                    {{else}}
                        {{#if hasLockedFiles}}
                        <div class="gallery-grid">
                            {{#each LockedFiles}}
                            <div class="gallery-item" data-url="{{url}}">
                                <div class="item-thumb-placeholder">
                                    <i class="f7-icons">lock_fill</i>
                                </div>
                                <img class="item-thumb" src="{{thumbnailUrl}}" onload="this.style.opacity=1" onerror="this.style.display='none'">
                                <div class="item-overlay">{{formattedDate}}</div>
                                <div class="item-badge"><i class="f7-icons">lock_fill</i></div>
                            </div>
                            {{/each}}
                        </div>
                        {{else}}
                        <div class="gallery-empty">
                            <i class="f7-icons">lock</i>
                            <p>No locked recordings found</p>
                        </div>
                        {{/if}}
                    {{/if}}
                </div>

                <!-- Snapshot Tab -->
                <div id="tab-snapshot" class="tab">
                    {{#if Loading}}
                    <div class="gallery-empty">
                        <div class="preloader"></div>
                        <p>Loading...</p>
                    </div>
                    {{else}}
                        {{#if hasSnapshotFiles}}
                        <div class="gallery-grid">
                            {{#each SnapshotFiles}}
                            <div class="gallery-item" data-url="{{url}}">
                                <div class="item-thumb-placeholder">
                                    <i class="f7-icons">photo</i>
                                </div>
                                <img class="item-thumb" src="{{url}}" onload="this.style.opacity=1" onerror="this.style.display='none'">
                                <div class="item-overlay">{{formattedDate}}</div>
                                <div class="item-badge"><i class="f7-icons">photo</i></div>
                            </div>
                            {{/each}}
                        </div>
                        {{else}}
                        <div class="gallery-empty">
                            <i class="f7-icons">photo</i>
                            <p>No snapshots found</p>
                        </div>
                        {{/if}}
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</template>

<style>
    .gallery-page .gallery-item {
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        background: #f0f0f0;
    }
    
    .gallery-page .gallery-item .item-thumb-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 1;
    }
    
    .gallery-page .gallery-item .item-thumb-placeholder i {
        font-size: 32px;
        color: rgba(255, 255, 255, 0.5);
    }
    
    .gallery-page .gallery-item .item-thumb {
        position: relative;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 2;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .gallery-page .gallery-item .item-overlay {
        z-index: 3;
    }
    
    .gallery-page .gallery-item .item-badge {
        z-index: 3;
    }
</style>

<script>
    return {
        data: function() {
            return {
                Loading: false,
                CameraFilter: 'front',
                isFrontCamera: true,
                isRearCamera: false,
                LoopFiles: [],
                LockedFiles: [],
                SnapshotFiles: [],
                hasLoopFiles: false,
                hasLockedFiles: false,
                hasSnapshotFiles: false
            };
        },
        methods: {
            loadAllFiles: function() {
                var self = this;
                
                // if (!AppStore.state.isConnected) {
                //     self.$app.dialog.alert('Please connect to camera first', 'Not Connected', function() {
                //         mainView.router.back();
                //     });
                //     return;
                // }
                
                self.$setState({ Loading: true });
                
                // Stop recording first to access files
                DASHCAM_API.stopRecording().then(function() {
                    AppStore.setRecording(false);
                    
                    // Load all files
                    Promise.all([
                        DASHCAM_API.getGalleryFiles('loop', self.CameraFilter),
                        DASHCAM_API.getGalleryFiles('locked', self.CameraFilter),
                        DASHCAM_API.getGalleryFiles('snapshot', self.CameraFilter)
                    ]).then(function(results) {
                        // Format dates
                        var formatFiles = function(files) {
                            return files.map(function(file) {
                                file.formattedDate = file.dateTime 
                                    ? self.$app.methods.formatDate(file.dateTime) 
                                    : file.filename;
                                return file;
                            });
                        };
                        
                        var loopFiles = formatFiles(results[0] || []);
                        var lockedFiles = formatFiles(results[1] || []);
                        var snapshotFiles = formatFiles(results[2] || []);
                        
                        self.$setState({
                            Loading: false,
                            LoopFiles: loopFiles,
                            LockedFiles: lockedFiles,
                            SnapshotFiles: snapshotFiles,
                            hasLoopFiles: loopFiles.length > 0,
                            hasLockedFiles: lockedFiles.length > 0,
                            hasSnapshotFiles: snapshotFiles.length > 0
                        });
                    }).catch(function(err) {
                        console.error('Failed to load gallery files:', err);
                        self.$setState({ 
                            Loading: false,
                            hasLoopFiles: false,
                            hasLockedFiles: false,
                            hasSnapshotFiles: false
                        });
                        self.$app.toast.show({
                            text: 'Failed to load gallery',
                            position: 'center',
                            closeTimeout: 2000
                        });
                    });
                }).catch(function(err) {
                    console.error('Failed to stop recording:', err);
                    self.$setState({ Loading: false });
                    self.$app.toast.show({
                        text: 'Failed to access gallery',
                        position: 'center',
                        closeTimeout: 2000
                    });
                });
            },
            setCameraFilter: function(filter) {
                var self = this;
                if (self.CameraFilter !== filter) {
                    self.CameraFilter = filter;
                    self.$setState({ 
                        CameraFilter: filter,
                        isFrontCamera: filter === 'front',
                        isRearCamera: filter === 'rear'
                    });
                    self.loadAllFiles();
                }
            },
            refreshGallery: function() {
                this.loadAllFiles();
            },
            openFile: function(url) {
                if (window.cordova && cordova.InAppBrowser) {
                    cordova.InAppBrowser.open(url, '_system');
                } else {
                    window.open(url, '_blank');
                }
            }
        },
        on: {
            pageInit: function(e, page) {
                var self = this;
                self.loadAllFiles();
                
                // Handle gallery item click
                page.$el.on('click', '.gallery-item', function() {
                    var url = this.dataset.url;
                    if (url) {
                        self.openFile(url);
                    }
                });
            }
        }
    };
</script>